<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Sirtec Doc Flow</title>
      
    <link rel="icon" href="../static/logo.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
    <link rel="stylesheet" href="https://rawcdn.githack.com/Loopple/loopple-public-assets/ad60f16c8a16d1dcad75e176c00d7f9e69320cd4/argon-dashboard/css/nucleo/css/nucleo.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='theme_home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loopple_pdf.css') }}">
    <link rel="stylesheet" href="../static/loopple_pdf.css">
    <link rel="stylesheet" href="../static/theme_home.css">
    
  </head>
  
  <body class="g-sidenav-show">
    <nav class="sidenav navbar navbar-vertical fixed-left navbar-expand-xs navbar-light bg-white loopple-fixed-start" id="sidenav-main">
        <nav class="sidenav navbar navbar-vertical fixed-left navbar-expand-xs navbar-light bg-white" id="sidenav-main">
            <div class="sidenav-header  align-items-center"> <a class="navbar-brand"> <img src="https://sirtec.com.br/restrito/logo.png" class="navbar-brand-img"> Sirtec Doc Flow</a> </div>
            <hr class="mt-0 mb-3">
            <div class="d-flex align-items-center"> <img src="https://static.vecteezy.com/ti/vetor-gratis/p1/7407996-user-icon-person-icon-client-symbol-login-head-sign-icon-design-vetor.jpg" class="avatar ml-3">
                <div class="ml-3">
                    <h4 class="mb-0">{{session['username']}}</h4>
                    <p class="text-xs mb-0">{{session['office']}}</p>
                </div>
            </div>
            <hr class="mt-3 mb-0">
            <div class="navbar-inner">
                <div class="collapse navbar-collapse" id="sidenav-collapse-main">
                    <ul class="navbar-nav">
                        <li class="nav-item"> <a class="nav-link {% if active_page == 'admin.admin' %}active{% endif %}" href="{{ url_for('admin.admin') }}"> <i class="fa fa-desktop"></i> <span class="nav-link-text">Home</span> </a> </li>
                        <li class="nav-item"> <a class="nav-link {% if active_page == 'pdf.pdf' %}active{% endif %}" href="{{ url_for('pdf.pdf') }}"> <i class="fa fa-file-pdf text-info"></i> <span class="nav-link-text">PDF</span> </a> </li>
                        <li class="nav-item"> <a class="nav-link {% if active_page == 'usuarios.usuarios' %}active{% endif %}" href="{{ url_for('usuarios.usuarios') }}"> <i class="fa fa-address-book "></i> <span class="nav-link-text">Usuários</span> </a> </li>
                        <li class="nav-item"> <a class="nav-link {% if active_page == 'old_files.old_files' %}active{% endif %}" href="{{ url_for('old_files.old_files') }}"><i class="fa fa-bookmark text-success"></i> <span class="nav-link-text">Documentos Antigos</span> </a> </li>
                        <li class="nav-item"> <a class="nav-link" href="javascript:"> <i class="fa fa-cog text-dark"></i> <span class="nav-link-text">Configurações</span> </a> </li>
                    </ul>
                </div>
                <div class="bg-gradient-primary card position-fixed bottom-0">
                </div>
            </div>
        </nav>
    </nav>
    <div class="main-content" id="panel">
        <nav class="navbar navbar-top navbar-expand navbar-dark bg-primary border-bottom" id="navbarTop">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav align-items-center  ml-md-auto ">
                        <li class="nav-item d-xl-none">
                            <div class="pr-3 sidenav-toggler sidenav-toggler-dark active" data-action="sidenav-pin" data-target="#sidenav-main">
                                <div class="sidenav-toggler-inner"> <i class="sidenav-toggler-line"></i> <i class="sidenav-toggler-line"></i> <i class="sidenav-toggler-line"></i> </div>
                            </div>
                        </li>
                        <li class="nav-item dropdown"> <a class="nav-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="fa fa-layer-group"></i> </a>
                            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-dark bg-default  dropdown-menu-right ">
                                <div class="row shortcuts px-4"> 
                                  <a href="https://sirtec.desk.ms/?Portal#Home" class="col-4 shortcut-item text-center"> 
                                      <span class="shortcut-media avatar rounded-circle bg-gradient-info "> 
                                          <i class="fa fa-book" aria-hidden="true"></i> 
                                      </span> 
                                      <small class="text-white">DeskManager</small> 
                                  </a> 
                                  <a href="https://autenticacao.allstrategy.com.br" class="col-4 shortcut-item text-center"> 
                                      <span class="shortcut-media avatar rounded-circle bg-gradient-red"> 
                                          <i class="fa fa-university"></i> 
                                      </span> 
                                      <small class="text-white">Plano</small> 
                                  </a> 
                                  <a href="https://sirtec.com.br/ti/index.php" class="col-4 shortcut-item text-center"> 
                                      <span class="shortcut-media avatar rounded-circle bg-gradient-orange"> 
                                          <i class="fa fa-users"></i> 
                                      </span> 
                                      <small class="text-white">Meu RH</small> 
                                  </a> 
                            </div>
                        </li>
                            <div class="dropdown-menu dropdown-menu-right dropdown-menu-xl py-0 overflow-hidden">
                                <div class="list-group list-group-flush"> 
                                    <a href="#!" class="list-group-item list-group-item-action">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <!-- Avatar --> <img alt="Image placeholder" src="https://cdn-icons-png.flaticon.com/256/5146/5146077.png" class="avatar rounded-circle"> </div>
                                        </div>
                                    </a> 
                                </div>
                            </div>
                        </li>
                    </ul>
                      <div>
                          <div class="list-group list-group-flush"> 
                              <a href="#" >
                                  <div class="row align-items-center">
                                      <div class="col-auto">
                                          <i class="fa fa-sign-out-alt avatar rounded-circle" onclick="logout()"></i>
                                      </div>
                                  </div>
                              </a> 
                          </div>
                      </div>
                </div>
            </div>
        </nav>
        <div class="container-fluid pt-3">
            <div class="row removable">
                <div class="col-lg-12 px-sm-0">
                    <div class="card shadow-none px-0 bg-transparent mt-0 mb-4">
                        <div class="card-body px-0 pb-0">
                            <div class="px-0 pb-4">
                                <div class="row flex-row">
                                    <div class="col-lg-12">
                                        <div class="card max-height-vh-70" style="max-height: 70vh;">
                                            <div class="card-header shadow-xl">
                                              <h2 class="text-center">Histórico de versões</h2>
                                            </div>
                                            <br>
                                            <form class="navbar-search navbar-search-dark form-inline ml-auto mb-0" id="navbar-search-main">
                                                <button type="button" class="close align-items-center" data-action="search-close" data-target="#navbar-search-main" aria-label="Close">
                                                    <span aria-hidden="true">×</span>
                                                </button>
                                                <br>
                                                <br>
                                                <div class="form-group mb-0">
                                                    <div class="input-group input-group input-group-merge">
                                                        <input class="form-control ml-2" id="searchInput" placeholder="Buscar" type="text">
                                                        <div class="input-group-append mr-2">
                                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                            <br>
                                            
                                            <div class="card-body overflow-auto overflow-x-hidden">
                                                <div class="row justify-content-start mb-8">
                                                    <table id="s3ContentTable" class="table align-items-center">
                                                        <thead>
                                                            <tr>
                                                                <th><h2 class="text-center">Pastas</h2></th>
                                                                
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for folder in folders %}
                                                                <tr class="folder-row" data-folder-name="{{ folder }}">
                                                                    <td style="display: flex; justify-content: space-between;"> <!-- Adicionando estilo flexbox -->
                                                                        <h3 class="text-center" style="margin: 0; cursor: pointer;">{{ folder.replace('Documents/', '').rstrip('/') }}</h3> 
                                                                        <input type="file" id="arquivos{{ loop.index }}" style="display: none;" multiple onchange="enviarArquivos(this.files, '{{ folder }}')">
                                                                        <button type="button" class="botao" onclick="document.getElementById('arquivos{{ loop.index }}').click();" data-folder="{{ folder }}">
                                                                            Adicionar Arquivos
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="card-footer d-block">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> 

        <!-- Animaçao de carregamento -->
        <div class="loader" style="display: none;"></div>

    </div>

    <!-- Footer -->
    <footer class="footer align-items-center text-center" style="position: absolute; bottom: 0; width: 100%; display: flex; justify-content: center;">
        <div class="row align-items-center justify-content-center justify-content-lg-between">
            <div class="col-lg-12">
                <div class="copyright text-center text-lg-left text-footer">© 2024 Made by<a class="font-weight-bold ml-1" href="#" target="_blank">VK</a> for<a class="font-weight-bold ml-1" href="#" target="_blank">Sirtec</a></div>
            </div>
        </div>
    </footer> 
    
    <script src="https://rawcdn.githack.com/Loopple/loopple-public-assets/5cef8f62939eeb089fa26d4c53a49198de421e3d/argon-dashboard/js/vendor/jquery.min.js"></script>
    <script src="https://rawcdn.githack.com/Loopple/loopple-public-assets/5cef8f62939eeb089fa26d4c53a49198de421e3d/argon-dashboard/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="https://rawcdn.githack.com/Loopple/loopple-public-assets/5cef8f62939eeb089fa26d4c53a49198de421e3d/argon-dashboard/js/vendor/js.cookie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="https://rawcdn.githack.com/Loopple/loopple-public-assets/5cef8f62939eeb089fa26d4c53a49198de421e3d/argon-dashboard/js/vendor/chart.extension.js"></script>
    <script src="https://rawcdn.githack.com/Loopple/loopple-public-assets/7bb803d2af2ab6d71d429b0cb459c24a4cd0fbb4/argon-dashboard/js/argon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{{ url_for('static', filename='main.js') }}"></script>
    

    <!-- Passando variável 'files' do Python para JavaScript -->
    <script type="application/json" id="filesData">
        {{ files|tojson|safe }}
    </script>
    <script type="text/javascript">
        var files = JSON.parse(document.getElementById('filesData').textContent);
    </script>
    
    <script>
        
        $(document).ready(function(){
            // Ativar a função de pesquisa
            $("#searchInput").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("#s3ContentTable tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {

            const folderRows = document.querySelectorAll('.folder-row');

            folderRows.forEach(function(row, index) {
                row.addEventListener('click', function() {
                    const folderName = this.dataset.folderName;

                    // Verifica se já existe uma lista abaixo desta pasta e a remove se existir
                    let nextElement = this.nextElementSibling;
                    if (nextElement && nextElement.classList.contains('file-list-row')) {
                        nextElement.parentNode.removeChild(nextElement);
                    } else {
                        // Cria uma nova linha e coluna para listar os arquivos
                        const fileListRow = document.createElement('tr');
                        fileListRow.classList.add('file-list-row');
                        const fileListTd = document.createElement('td');
                        fileListTd.colSpan = "2";
                        const fileListUl = document.createElement('ul');

                        // Tentando acessar os arquivos para a pasta clicada
                        const filesInFolder = files[folderName] || [];

                        filesInFolder.forEach(function(file) {
                            const fileLink = `<li><a href="${file.url}" target="_blank">${file.name}</a></li>`;
                            fileListUl.innerHTML += fileLink;
                        });

                        if (filesInFolder.length === 0) {
                            fileListUl.innerHTML = '<li>Não existem arquivos a serem exibidos</li>';
                        }

                        fileListTd.appendChild(fileListUl);
                        fileListRow.appendChild(fileListTd);
                        this.parentNode.insertBefore(fileListRow, this.nextSibling);
                    }
                });
            });
        });

        function enviarArquivos(arquivos, folderName) {
            var formData = new FormData();
            formData.append('folder', folderName);

            // Mostrar o loader
            document.querySelector('.loader').style.display = 'block';

            // Iterar sobre todos os arquivos selecionados
            for (var i = 0; i < arquivos.length; i++) {
                var file = arquivos[i];
                formData.append('files[]', file, file.name); // Adicionar cada arquivo ao FormData com seu nome
            }

            $.ajax({
                url: '/send_files',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    // Esconder o loader
                    document.querySelector('.loader').style.display = 'none';

                    // Exibir alerta de sucesso com SweetAlert
                    Swal.fire({
                        icon: 'success',
                        title: 'Arquivos enviados com sucesso!',
                        showConfirmButton: false,
                        timer: 1500 // Tempo em milissegundos que o alerta ficará visível
                    }).then(function() {
                        // Redirecionar para a página desejada após o envio
                        window.location.href = response.redirect;
                    });
                },
                error: function(xhr, status, error) {
                    // Esconder o loader em caso de erro
                    document.querySelector('.loader').style.display = 'none';

                    // Exibir alerta de erro com SweetAlert
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro ao enviar arquivos!',
                        text: 'Por favor, tente novamente mais tarde.',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }

        function logout() {
            window.location.href = "{{ url_for('logout.logout') }}";
        }

    </script>
    <script src="{{ url_for('static', filename='loopple.js') }}"></script>
  </body>